
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>resilient_circuits.actions_component &#8212; Resilient Python API 40.0.100 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for resilient_circuits.actions_component</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># (c) Copyright IBM Corp. 2010, 2019. All Rights Reserved.</span>

<span class="sd">&quot;&quot;&quot;Circuits component for Action Module subscription and message handling&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">signal</span> <span class="kn">import</span> <span class="n">SIGINT</span><span class="p">,</span> <span class="n">SIGTERM</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">circuits</span> <span class="kn">import</span> <span class="n">BaseComponent</span><span class="p">,</span> <span class="n">Worker</span>
<span class="kn">from</span> <span class="nn">circuits.core.manager</span> <span class="kn">import</span> <span class="n">ExceptionWrapper</span>
<span class="kn">from</span> <span class="nn">circuits.core.handlers</span> <span class="kn">import</span> <span class="n">handler</span>
<span class="kn">from</span> <span class="nn">requests.utils</span> <span class="kn">import</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>
<span class="kn">import</span> <span class="nn">resilient</span>
<span class="kn">from</span> <span class="nn">resilient</span> <span class="kn">import</span> <span class="n">ensure_unicode</span>
<span class="kn">import</span> <span class="nn">resilient_circuits.actions_test_component</span> <span class="k">as</span> <span class="nn">actions_test_component</span>
<span class="kn">from</span> <span class="nn">resilient_circuits.decorators</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1"># for back-compatibility, these were previously declared here</span>
<span class="kn">from</span> <span class="nn">resilient_circuits.rest_helper</span> <span class="kn">import</span> <span class="n">get_resilient_client</span><span class="p">,</span> <span class="n">reset_resilient_client</span>
<span class="kn">from</span> <span class="nn">resilient_circuits.action_message</span> <span class="kn">import</span> <span class="n">ActionMessageBase</span><span class="p">,</span> <span class="n">ActionMessage</span><span class="p">,</span> \
    <span class="n">FunctionMessage</span><span class="p">,</span> <span class="n">StatusMessage</span><span class="p">,</span> <span class="n">FunctionResult</span><span class="p">,</span> <span class="n">BaseFunctionError</span>
<span class="kn">from</span> <span class="nn">resilient_circuits.stomp_component</span> <span class="kn">import</span> <span class="n">StompClient</span>
<span class="kn">from</span> <span class="nn">resilient_circuits.stomp_events</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">resilient_circuits</span> <span class="kn">import</span> <span class="n">helpers</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">STOMP_CLIENT_HEARTBEAT</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># no heartbeat from client to server</span>
<span class="n">STOMP_SERVER_HEARTBEAT</span> <span class="o">=</span> <span class="mi">15000</span>      <span class="c1"># 15-second heartbeat from server to client</span>
<span class="n">RETRY_TIMER_INTERVAL</span> <span class="o">=</span> <span class="mi">60</span>           <span class="c1"># Retry failed deliveries every minute</span>
<span class="n">SUBSCRIBE_TO_QUEUES_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>    <span class="c1"># connect event timeout</span>

<span class="c1"># Global idle timer, fires after 10 minutes to reset the REST connection</span>
<span class="n">IDLE_TIMER_INTERVAL</span> <span class="o">=</span> <span class="mi">600</span>
<span class="n">_idle_timer</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># look for unrecoverable errors</span>
<span class="n">UNRECOVERABLE_ERRORS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Already subscribed&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">validate_cert</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Utility wrapper for SSL validation on the STOMP connection&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resilient</span><span class="o">.</span><span class="n">match_hostname</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">hostname</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;Success&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FunctionWorker</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>

    <span class="n">channel</span> <span class="o">=</span> <span class="s2">&quot;functionworker&quot;</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signo</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a signal handler to the worker processes otherwise they swallow SIGINT, SIGTERM</span>
<span class="sd">           (see FallBackSignalHandler in circuits/core/helpers.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signo</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">]:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Worker interrupted&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;task&quot;</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Task: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
            <span class="k">yield</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ExceptionWrapper</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<div class="viewcode-block" id="ResilientComponent"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent">[docs]</a><span class="k">class</span> <span class="nc">ResilientComponent</span><span class="p">(</span><span class="n">BaseComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Circuits base component with a connection to the Resilient APIs.</span>

<span class="sd">       This is the superclass for custom Resilient Action Module components.</span>
<span class="sd">       If a component inherits from ResilientComponent, it will automatically be loaded,</span>
<span class="sd">       and actions and functions will be dispatched to its `handler` and `function` methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_mode</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True with --test-actions option</span>

<div class="viewcode-block" id="ResilientComponent.__init__"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResilientComponent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn_names</span> <span class="o">=</span> <span class="n">helpers</span><span class="o">.</span><span class="n">get_fn_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Get fields, message destinations and functions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_get_fields</span><span class="p">(</span><span class="n">fn_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fn_names</span><span class="p">)</span>

        <span class="c1"># If this component is a function, self.fn_names will be defined</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_names</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;@function handler names: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_names</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">fn_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">helpers</span><span class="o">.</span><span class="n">check_exists</span><span class="p">(</span><span class="n">fn_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Function &#39;</span><span class="si">{0}</span><span class="s2">&#39; is not defined in this Resilient platform!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn_name</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check that decorated requirements are met</span>
            <span class="n">callables</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">Callable</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">callables</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__class__&quot;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="c1"># Do all the custom fields exist?</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;required_fields&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">input_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fielddef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Field &#39;</span><span class="si">{0}</span><span class="s2">&#39; (required by &#39;</span><span class="si">{1}</span><span class="s2">&#39;) is not &quot;</span>
                                <span class="s2">&quot;defined in this Resilient platform.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fielddef</span><span class="p">[</span><span class="s2">&quot;input_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">input_type</span><span class="p">:</span>
                            <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Field &#39;</span><span class="si">{0}</span><span class="s2">&#39; (required by &#39;</span><span class="si">{1}</span><span class="s2">&#39;) &quot;</span>
                                    <span class="s2">&quot;must be type &#39;</span><span class="si">{2}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span>
                                                        <span class="n">name</span><span class="p">,</span> <span class="n">input_type</span><span class="p">))</span>
                <span class="c1"># Do all the action fields exist?</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;required_action_fields&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">input_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fielddef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Action field &#39;</span><span class="si">{0}</span><span class="s2">&#39; (required by &#39;</span><span class="si">{1}</span><span class="s2">&#39;) &quot;</span>
                                <span class="s2">&quot;is not defined in this Resilient platform.&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">input_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fielddef</span><span class="p">[</span><span class="s2">&quot;input_type&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">input_type</span><span class="p">:</span>
                            <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Action field &#39;</span><span class="si">{0}</span><span class="s2">&#39; (required by &quot;</span>
                                    <span class="s2">&quot;&#39;</span><span class="si">{1}</span><span class="s2">&#39;) must be type &#39;</span><span class="si">{2}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">errmsg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span>
                                                        <span class="n">name</span><span class="p">,</span> <span class="n">input_type</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get Incident and Action fields&quot;&quot;&quot;</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">field</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">cached_get</span><span class="p">(</span><span class="s2">&quot;/types/incident/fields&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_action_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">field</span><span class="p">)</span>
                                   <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">cached_get</span><span class="p">(</span><span class="s2">&quot;/types/actioninvocation/fields&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">fn_names</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">fn_name</span> <span class="ow">in</span> <span class="n">fn_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span><span class="p">[</span><span class="n">fn_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">cached_get</span><span class="p">(</span><span class="s2">&quot;/functions/</span><span class="si">{0}</span><span class="s2">?handle_format=names&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn_name</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">cached_get</span><span class="p">(</span><span class="s2">&quot;/types/__function/fields&quot;</span><span class="p">))</span>

            <span class="k">except</span> <span class="n">resilient</span><span class="o">.</span><span class="n">SimpleHTTPException</span><span class="p">:</span>
                <span class="c1"># functions are not available, pre-v30 server</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_functions</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ResilientComponent.rest_client"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.rest_client">[docs]</a>    <span class="k">def</span> <span class="nf">rest_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a connected instance of the :class:`resilient.SimpleClient`</span>
<span class="sd">        that can be used to access the Resilient REST API.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_idle_timer</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">get_resilient_client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">)</span></div>

<div class="viewcode-block" id="ResilientComponent.reset_idle_timer"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.reset_idle_timer">[docs]</a>    <span class="k">def</span> <span class="nf">reset_idle_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create an idle-timer that we can use to reset the REST connection&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_idle_timer</span>
        <span class="k">if</span> <span class="n">_idle_timer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;create idle timer&quot;</span><span class="p">)</span>
            <span class="n">_idle_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">IDLE_TIMER_INTERVAL</span><span class="p">,</span>
                                <span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;idle_reset&quot;</span><span class="p">),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">_idle_timer</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_idle_timer</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResilientComponent.get_incident_field"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_incident_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_incident_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the definition of an incident-field&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span></div>

<div class="viewcode-block" id="ResilientComponent.get_incident_fields"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_incident_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_incident_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the definitions of all incident-fields, as a list&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResilientComponent.get_field_label"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_field_label">[docs]</a>    <span class="k">def</span> <span class="nf">get_field_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the label for an incident-field value id&quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value_id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value_id</span></div>

<div class="viewcode-block" id="ResilientComponent.get_action_field"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_action_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_action_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the definition of an action-field&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span></div>

<div class="viewcode-block" id="ResilientComponent.get_action_fields"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_action_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_action_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the definitions of all action-fields, as a list&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span></div>

<div class="viewcode-block" id="ResilientComponent.get_action_field_label"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_action_field_label">[docs]</a>    <span class="k">def</span> <span class="nf">get_action_field_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the label for an action-field value id&quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value_id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">value_id</span><span class="p">)</span>  <span class="c1"># fallback</span></div>

<div class="viewcode-block" id="ResilientComponent.get_function_field"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_function_field">[docs]</a>    <span class="k">def</span> <span class="nf">get_function_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the definition of a function input field (parameter)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ResilientComponent.get_function_fields"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_function_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_function_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the definitions of all function input-fields (parameters), as a list&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ResilientComponent.get_function_field_label"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_function_field_label">[docs]</a>    <span class="k">def</span> <span class="nf">get_function_field_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the label for a function input-field value id&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value_id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ensure_unicode</span><span class="p">(</span><span class="n">value_id</span><span class="p">)</span>  <span class="c1"># fallback</span></div>

<div class="viewcode-block" id="ResilientComponent.get_select_param"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_select_param">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_select_param</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function Helper: get the label from a select- or multi-select parameter&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">ResilientComponent</span><span class="o">.</span><span class="n">get_select_param</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="ResilientComponent.get_textarea_param"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.get_textarea_param">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_textarea_param</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function Helper: get the content from a textarea-type parameter&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></div>

<div class="viewcode-block" id="ResilientComponent.reload"><a class="viewcode-back" href="../../resilient_circuits.html#resilient_circuits.ResilientComponent.reload">[docs]</a>    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;reload&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Event handler called when the configuration options have changed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opts</span> <span class="o">=</span> <span class="n">opts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_fields</span><span class="p">()</span></div></div>


<span class="k">class</span> <span class="nc">Actions</span><span class="p">(</span><span class="n">ResilientComponent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Component that subscribes to Resilient Action Module queues and fires message events&quot;&quot;&quot;</span>

    <span class="c1"># Whenever a component in the circuit is registered to a channel name &quot;actions.xxxx&quot;,</span>
    <span class="c1"># this component will subscribe to the corresponding Action Module queue (xxxx)</span>
    <span class="c1"># and then fire events for each message that arrives from the queue.</span>
    <span class="c1"># After the message is handled, or fails, it acks the message and updates the action status.</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Actions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># messages and acks that failed to send over stomp connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Read the action definitions, into a dict indexed by id</span>
        <span class="c1"># we&#39;ll refer to them later when dispatching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_stomp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_defs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscribe_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retry_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp_max_retries&quot;</span><span class="p">))</span> <span class="c1"># default from app.py:DEFAULT_STOMP_MAX_RETRIES</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stomp_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp_timeout&quot;</span><span class="p">,</span> <span class="n">SUBSCRIBE_TO_QUEUES_TIMEOUT</span><span class="p">))</span>

        <span class="n">timer_internal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;resilient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp_timer_interval&quot;</span><span class="p">,</span> <span class="n">RETRY_TIMER_INTERVAL</span><span class="p">))</span>

        <span class="n">_retry_timer</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">(</span><span class="n">timer_internal</span><span class="p">,</span> <span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;retry_failed_deliveries&quot;</span><span class="p">),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_retry_timer</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Make a worker thread-pool that will run functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_functionworker</span> <span class="o">=</span> <span class="n">FunctionWorker</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="s2">&quot;functionworker&quot;</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_workers&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_functionworker</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_actions&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Let user submit test actions from the command line for testing</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action Tests enabled. Run &#39;resilient-circuits test&#39; for the interactive action test tool.&quot;</span><span class="p">)</span>
            <span class="n">test_options</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_port&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">test_options</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;test_port&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;test_host&quot;</span><span class="p">):</span>
                <span class="n">test_options</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;test_host&quot;</span><span class="p">]</span>
            <span class="n">actions_test_component</span><span class="o">.</span><span class="n">ResilientTestActions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_id</span><span class="p">,</span>
                                                        <span class="o">**</span><span class="n">test_options</span><span class="p">)</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_configure_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handle settings from configuration &quot;&quot;&quot;</span>
        <span class="c1"># Set options for connecting to Action Module with HTTP Proxy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">proxy_host</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy_host&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_host</span><span class="p">:</span>
            <span class="n">proxy_host</span> <span class="o">=</span> <span class="n">proxy_host</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;proxy_host&quot;</span><span class="p">:</span> <span class="n">proxy_host</span><span class="p">,</span>
                                <span class="s2">&quot;proxy_port&quot;</span><span class="p">:</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy_port&quot;</span><span class="p">),</span>
                                <span class="s2">&quot;proxy_user&quot;</span><span class="p">:</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy_user&quot;</span><span class="p">),</span>
                                <span class="s2">&quot;proxy_password&quot;</span><span class="p">:</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy_password&quot;</span><span class="p">)}</span>

        <span class="n">rest_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_id</span> <span class="o">=</span> <span class="n">rest_client</span><span class="o">.</span><span class="n">org_id</span>

        <span class="n">list_action_defs</span> <span class="o">=</span> <span class="n">rest_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/actions&quot;</span><span class="p">)[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_defs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span> <span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">list_action_defs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subscribe_headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;activemq.prefetchSize&quot;</span><span class="p">:</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;stomp_prefetch_limit&quot;</span><span class="p">]}</span>

    <span class="c1"># Public Utility methods</span>

    <span class="k">def</span> <span class="nf">action_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the name of an action, from its id&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Unnamed action, probably triggered from a v28 workflow</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Action: _unnamed_&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;_unnamed_&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_defs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action_id</span><span class="p">):</span>
            <span class="n">defn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_defs</span><span class="p">[</span><span class="n">action_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Action </span><span class="si">%s</span><span class="s2"> is unknown.&quot;</span><span class="p">,</span> <span class="n">action_id</span><span class="p">)</span>
            <span class="c1"># Refresh the list of action definitions</span>
            <span class="n">list_action_defs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_client</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/actions&quot;</span><span class="p">)[</span><span class="s2">&quot;entities&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action_defs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span>
                                     <span class="n">action</span><span class="p">)</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">list_action_defs</span><span class="p">)</span>

            <span class="n">defn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_defs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;_unnamed_&quot;</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">defn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">defn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;_unnamed_&quot;</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Connected&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_stomp_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Client has connected to the STOMP server&quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STOMP connected.&quot;</span><span class="p">)</span>
        <span class="c1"># Stop retrying the failed deliveries from previous session</span>
        <span class="c1"># We&#39;ll ack them right away if they are re-delivered</span>
        <span class="c1"># TODO: We should age these out of here at some point. 24 hours?</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;from_prev_conn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;from_prev_conn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;HeartbeatTimeout&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_heartbeat_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Heartbeat timed out from the STOMP server&quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Reconnecting after STOMP heartbeat timeout.&quot;</span><span class="p">)</span>
        <span class="c1"># Disconnect and Reconnect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Disconnect</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;OnStompError&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_stomp_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STOMP produced an error.&quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;STOMP listener: Error:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="ow">or</span> <span class="n">error</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">unrecoverable_error</span> <span class="ow">in</span> <span class="n">UNRECOVERABLE_ERRORS</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">message</span> <span class="ow">and</span> <span class="n">unrecoverable_error</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="n">error</span> <span class="ow">and</span> <span class="n">unrecoverable_error</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecoverable error. Exiting&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Just raise the event for anyone listening</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="s2">&quot;exception&quot;</span><span class="p">,</span> <span class="s2">&quot;Actions&quot;</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">),</span> <span class="n">message</span><span class="p">))</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_stomp_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STOMP produced a message.&quot;&quot;&quot;</span>
        <span class="c1"># Find the queue name from the subscription id (stomp_listener_xxx)</span>
        <span class="n">msg_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message-id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">msg_id</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Received message with no message id. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Stomp message with no message id received&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">msg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span> <span class="ow">or</span> <span class="n">msg_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">:</span>
            <span class="c1"># This is a message we have already processed but we failed to acknowledge</span>
            <span class="c1"># Don&#39;t process it again, just acknowledge it</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping reprocess of message </span><span class="si">%s</span><span class="s2">.  Sending saved ack now.&quot;</span><span class="p">,</span> <span class="n">msg_id</span><span class="p">)</span>
            <span class="n">failure_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">failure_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Send</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">:</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">]},</span>
                               <span class="n">body</span><span class="o">=</span><span class="n">failure_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">],</span>
                               <span class="n">destination</span><span class="o">=</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;reply-to&#39;</span><span class="p">],</span>
                               <span class="n">message_id</span><span class="o">=</span><span class="n">msg_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
            <span class="n">failure_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">failure_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Ack</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">msg_id</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">subscription</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">get_subscription</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;STOMP listener: message for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">subscription</span><span class="p">)</span>
            <span class="n">queue_name</span> <span class="o">=</span> <span class="n">subscription</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="s2">&quot;actions.&quot;</span> <span class="o">+</span> <span class="n">queue_name</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got Message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Expect the message payload to always be UTF8 JSON.</span>
                <span class="c1"># However, it may contain surrogate pairs, and in Python 3 that causes problems:</span>
                <span class="c1"># - surrogate pairs are not allowed by the default (strict) utf8 decoder,</span>
                <span class="c1"># - if we pass them, it will cause downstream issues, so we should re-encode.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mstr</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed utf8 decode, trying surrogate&quot;</span><span class="p">)</span>
                    <span class="n">mstr</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s2">&quot;surrogatepass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-16&quot;</span><span class="p">,</span> <span class="s2">&quot;surrogatepass&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-16&quot;</span><span class="p">)</span>

                <span class="n">message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">mstr</span><span class="p">)</span>
                <span class="c1"># Construct a Circuits event with the message, and fire it on the channel</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="p">):</span>
                    <span class="n">channel</span> <span class="o">=</span> <span class="s2">&quot;functions.&quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">FunctionMessage</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                            <span class="n">frame</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                                            <span class="n">log_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">ActionMessage</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                          <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                          <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                          <span class="n">frame</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                                          <span class="n">log_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Event: </span><span class="si">%s</span><span class="s2"> Channel: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DATA:</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="c1"># Normally the event won&#39;t be ack&#39;d.  Just report it and carry on.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_message_failure</span><span class="p">:</span>
                    <span class="c1"># Construct and fire anyway, which will ack the message</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This message failure will be ignored...&quot;</span><span class="p">)</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">ActionMessage</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                          <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                          <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">frame</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span>
                                          <span class="n">log_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>

    <span class="c1"># Circuits event handlers</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;idle_reset&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">idle_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Idle reset&quot;</span><span class="p">)</span>
        <span class="n">reset_resilient_client</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_stomp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rest_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_client</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rest_client</span><span class="o">.</span><span class="n">actions_enabled</span><span class="p">:</span>
            <span class="c1"># Don&#39;t create stomp connection b/c action module is not enabled.</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span><span class="s2">&quot;Resilient action module not enabled.&quot;</span>
                        <span class="s2">&quot;No stomp connection attempted.&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resilient_mock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;resilient_mock&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resilient_mock</span><span class="p">:</span>
            <span class="c1"># Using mock API, no need to create a real stomp connection</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using Mock. No Stomp connection&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Gather the stomp_cafile for if specified or fallback to the resilient host. Used for TLS / SSL</span>
        <span class="n">cafile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp_cafile&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">cafile</span>
        <span class="k">if</span> <span class="n">cafile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cafile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="c1"># Explicitly disable TLS certificate validation, if you need to</span>
            <span class="n">cafile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">((</span><span class="s2">&quot;Unverified STOMP TLS certificate (cafile=false)&quot;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">cafile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Since the REST API (resilient library) uses &#39;requests&#39;, let&#39;s use its default certificate bundle</span>
            <span class="c1"># instead of the certificates from ssl.get_default_verify_paths().cafile</span>
            <span class="n">cafile</span> <span class="o">=</span> <span class="n">DEFAULT_CA_BUNDLE_PATH</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOMP TLS validation with default certificate file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cafile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOMP TLS validation with certificate file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cafile</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ca_certs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="n">cafile</span><span class="p">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">check_hostname</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">cafile</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span> <span class="k">if</span> <span class="n">cafile</span> <span class="k">else</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c1"># Likely an older ssl version w/out true ssl context</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t create SSL context. Using fallback method&quot;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ca_certs</span> <span class="o">=</span> <span class="n">cafile</span>

        <span class="c1"># Gather the stomp_host if specified or fallback to the resilient host if not</span>
        <span class="n">stomp_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;resilient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp_host&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span>
        <span class="c1">#</span>
        <span class="c1">#   key_id and key_secret are the preferrable one</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_key_secret&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stomp_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;api_key_id&quot;</span><span class="p">]</span>
            <span class="n">stomp_password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;api_key_secret&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stomp_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
            <span class="n">stomp_password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>

        <span class="c1"># Set up a STOMP connection to the Resilient action services</span>
        <span class="n">stomp_timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp_timeout&quot;</span><span class="p">))</span> <span class="c1"># default from app.py:DEFAULT_STOMP_TIMEOUT</span>
        <span class="c1"># build out all the extra parameters for the stomp connections</span>
        <span class="n">stomp_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s1">&#39;resilient&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stomp_params&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="o">=</span> <span class="n">StompClient</span><span class="p">(</span><span class="n">stomp_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;stomp_port&quot;</span><span class="p">],</span>
                                               <span class="n">username</span><span class="o">=</span><span class="n">stomp_email</span><span class="p">,</span>
                                               <span class="n">password</span><span class="o">=</span><span class="n">stomp_password</span><span class="p">,</span>
                                               <span class="n">heartbeats</span><span class="o">=</span><span class="p">(</span><span class="n">STOMP_CLIENT_HEARTBEAT</span><span class="p">,</span>
                                                           <span class="n">STOMP_SERVER_HEARTBEAT</span><span class="p">),</span>
                                               <span class="n">connected_timeout</span><span class="o">=</span><span class="n">stomp_timeout</span><span class="p">,</span>
                                               <span class="n">connect_timeout</span><span class="o">=</span><span class="n">stomp_timeout</span><span class="p">,</span>
                                               <span class="n">ssl_context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                                               <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">,</span>  <span class="c1"># For old ssl version</span>
                                               <span class="n">stomp_params</span><span class="o">=</span><span class="n">stomp_params</span><span class="p">,</span>
                                               <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Component exists, just update it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">stomp_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;stomp_port&quot;</span><span class="p">],</span>
                                      <span class="n">username</span><span class="o">=</span><span class="n">stomp_email</span><span class="p">,</span>
                                      <span class="n">password</span><span class="o">=</span><span class="n">stomp_password</span><span class="p">,</span>
                                      <span class="n">heartbeats</span><span class="o">=</span><span class="p">(</span><span class="n">STOMP_CLIENT_HEARTBEAT</span><span class="p">,</span>
                                                  <span class="n">STOMP_SERVER_HEARTBEAT</span><span class="p">),</span>
                                      <span class="n">connected_timeout</span><span class="o">=</span><span class="n">stomp_timeout</span><span class="p">,</span>
                                      <span class="n">connect_timeout</span><span class="o">=</span><span class="n">stomp_timeout</span><span class="p">,</span>
                                      <span class="n">ssl_context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
                                      <span class="n">ca_certs</span><span class="o">=</span><span class="n">ca_certs</span><span class="p">,</span>  <span class="c1"># For old ssl version</span>
                                      <span class="n">stomp_params</span><span class="o">=</span><span class="n">stomp_params</span><span class="p">,</span>
                                      <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_proxy_args</span><span class="p">)</span>

        <span class="c1"># Other special options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_message_failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;resilient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignore_message_failure&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">,</span> <span class="n">subscribe</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_setup_message_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store action message logging option &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;log_http_responses&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span><span class="p">)</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span> <span class="o">=</span> <span class="n">directory</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logging_directory</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Response Logging Directory </span><span class="si">%s</span><span class="s2"> does not exist!&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;log_http_responses&quot;</span><span class="p">])</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;registered&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A component has registered.  Subscribe to its message queue(s).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">component</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_stomp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_message_logging</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_stomp</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="c1"># The set of channels for this component is:</span>
        <span class="c1"># - the component&#39;s channel(s) declared at class level, and</span>
        <span class="c1"># - any channel(s) declared at individual handlers</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">component</span><span class="o">.</span><span class="n">handlers</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
                <span class="n">channels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">handler</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;actions.&quot;</span><span class="p">):</span>
                <span class="c1"># Action module handler, channel &quot;actions.xx&quot; subscribes to &quot;xx&quot;</span>
                <span class="n">queue_name</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; actions registered to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                         <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;functions.&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">component</span><span class="o">.</span><span class="n">_functions</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_mode</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Function handler, channel &quot;functions.xx&quot; subscribes to the message dest associated with function &quot;xx&quot;</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">func_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">component</span><span class="o">.</span><span class="n">_functions</span><span class="p">:</span>
                    <span class="c1"># Unknown function.  Log it and continue.</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; function &#39;</span><span class="si">%s</span><span class="s2">&#39; is not defined!&quot;</span><span class="p">,</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">queue_name</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">_functions</span><span class="p">[</span><span class="n">func_name</span><span class="p">][</span><span class="s2">&quot;destination_handle&quot;</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; function &#39;</span><span class="si">%s</span><span class="s2">&#39; registered to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                         <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
                <span class="n">comps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">component</span><span class="p">])</span>
                <span class="n">comps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">comps</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">component</span><span class="p">])</span>
                <span class="c1"># Defer subscribing until all components are loaded</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;load_all_success&quot;</span><span class="p">,</span> <span class="s2">&quot;subscribe_to_all&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">subscribe_to_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Subscribe to all message queues &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s2">&quot;Connected&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stomp_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t subscribe to queues with STOMP disconnected, trying reconnect&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;resilient-circuits has started successfully and is now running...&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">queue_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subscribe</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;prepare_unregister&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">prepare_unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A component is unregistering.  Unsubscribe its message queue(s).&quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;component </span><span class="si">%s</span><span class="s2"> has unregistered&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">component</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;disconnecting Actions component from stomp queue&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_stomp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
                <span class="c1"># TODO: Confirm the stomp component gets garbage collected automatically</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">unregister</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;actions.&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Component </span><span class="si">%s</span><span class="s2"> unregistered from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="nb">str</span><span class="p">(</span><span class="n">component</span><span class="p">),</span> <span class="n">channel</span><span class="p">)</span>
            <span class="n">queue_name</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Channel </span><span class="si">%s</span><span class="s2"> was not subscribed&quot;</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">component</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Component </span><span class="si">%s</span><span class="s2"> was not subscribed&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">comps</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">comps</span><span class="p">:</span>
                <span class="c1"># All components have unsubscribed this destination; stop listening</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribe</span><span class="p">(</span><span class="n">queue_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">comps</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Listeners: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Actually subscribe the STOMP queue.  Note: this use client-ack, not auto-ack&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resilient_mock</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">queue_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">subscribed</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ignoring request to subscribe to </span><span class="si">%s</span><span class="s2">.  Already subscribed&quot;</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subscribe to message destination &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;actions.</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_id</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Subscribe</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">additional_headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subscribe_headers</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid request to subscribe to </span><span class="si">%s</span><span class="s2"> in state Connected? [</span><span class="si">%s</span><span class="s2">] with </span><span class="si">%d</span><span class="s2"> listeners&quot;</span><span class="p">,</span>
                      <span class="n">queue_name</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="k">else</span> <span class="s2">&quot;NO COMPONENT&quot;</span><span class="p">,</span>
                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unsubscribe the STOMP queue&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">queue_name</span><span class="p">]:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unsubscribe from message destination &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                     <span class="n">queue_name</span><span class="p">)</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;actions.</span><span class="si">{0}</span><span class="s2">.</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">org_id</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Unsubscribe</span><span class="p">(</span><span class="n">destination</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;disconnect stomp connection&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Disconnect</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="n">reconnect</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">))</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subscribe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try (re)connect to the STOMP server&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resilient_mock</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">socket_connected</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOMP reconnect requested when already connected&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;resilient&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stomp&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STOMP connection is not enabled&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">socket_connected</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Disconnecting socket before Connect attempt&quot;</span><span class="p">)</span>
                <span class="n">disconnect_event</span> <span class="o">=</span> <span class="n">Disconnect</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">disconnect_event</span><span class="p">)</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">disconnect_event</span><span class="p">)</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STOMP attempting to connect&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Connect</span><span class="p">(</span><span class="n">subscribe</span><span class="o">=</span><span class="n">subscribe</span><span class="p">))</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Connect_success&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">connected_succesfully</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Connected to stomp, subscribe if required &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Connected successfully. Resubscribe? </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">subscribe</span><span class="p">)</span>
        <span class="c1"># This is used to automatically re-subscribe to queues on a reconnect</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">subscribe</span><span class="p">:</span>
            <span class="n">subscribe_event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;subscribe_to_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">subscribe_event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">subscribe_event</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Disconnected&quot;</span><span class="p">)</span>
    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;ConnectionFailed&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">retry_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Try again later</span>
        <span class="n">reloading</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;reloading&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">reconnect</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reloading</span><span class="p">:</span>
            <span class="n">Timer</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;exception&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fevent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Report an exception thrown during handling of an action event&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">etype</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">BaseFunctionError</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">+=</span> <span class="n">unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">etype</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="n">etype</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="sa">u</span><span class="s2">&quot;: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;Processing failed&quot;</span>
                <span class="k">if</span> <span class="n">traceback</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">traceback</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="p">))</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fevent</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">etype</span><span class="p">),</span> <span class="n">message</span><span class="p">)</span>

            <span class="c1"># Try find the underlying Action or Function message</span>
            <span class="k">if</span> <span class="n">fevent</span> <span class="ow">and</span> <span class="n">fevent</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fevent</span><span class="p">,</span> <span class="n">ActionMessageBase</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">fevent</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ActionMessageBase</span><span class="p">):</span>
                        <span class="n">fevent</span> <span class="o">=</span> <span class="n">arg</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">fevent</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fevent</span><span class="p">,</span> <span class="n">ActionMessageBase</span><span class="p">):</span>
                <span class="n">fevent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># Stop further event processing</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">fevent</span><span class="o">.</span><span class="n">hdr</span><span class="p">()</span>
                <span class="c1"># Ack the message</span>
                <span class="n">message_id</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message-id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Ack</span><span class="p">(</span><span class="n">fevent</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">))</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ack </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message_id</span><span class="p">)</span>
                <span class="c1"># Reply with error status</span>
                <span class="n">reply_to</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;reply-to&#39;</span><span class="p">]</span>
                <span class="n">correlation_id</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">]</span>
                <span class="n">reply_message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                                            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                                            <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Send</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">},</span>
                                   <span class="n">body</span><span class="o">=</span><span class="n">reply_message</span><span class="p">,</span>
                                   <span class="n">destination</span><span class="o">=</span><span class="n">reply_to</span><span class="p">,</span>
                                   <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Test action, nothing to Ack</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;test_response&quot;</span><span class="p">,</span>
                                           <span class="n">fevent</span><span class="o">.</span><span class="n">test_msg_id</span><span class="p">,</span> <span class="n">reply_message</span><span class="p">))</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Test Action: No ack done.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Exception handler threw exception! Response to action module may not have sent.&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Ack_failure&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_ack_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;STOMP Ack failed to send, add to delivery failures&quot;&quot;&quot;</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span>
        <span class="n">failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retry_count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">failure</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retry_count</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Giving up after </span><span class="si">%d</span><span class="s2"> attempts on delivery of STOMP ACK for message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">failure</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">],</span> <span class="n">message_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="s2">&quot;from_prev_conn&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="s2">&quot;message_frame&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">frame</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">[</span><span class="n">message_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed </span><span class="si">%d</span><span class="s2"> times to deliver stomp ack for message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">failure</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">],</span> <span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Ack_success&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_ack_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retry for sending STOMP ACK for message id </span><span class="si">%s</span><span class="s2"> successful.&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Send_success&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_send_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retry for sending Resilient ACK for message id </span><span class="si">%s</span><span class="s2"> successful.&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;Send_failure&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_send_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resilient Ack failed to send, add to delivery failures&quot;&quot;&quot;</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">message_id</span>

        <span class="n">failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retry_count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">failure</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retry_count</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Giving up after </span><span class="si">%d</span><span class="s2"> attempts on delivery of Resilient ACK for message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="n">failure</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">],</span> <span class="n">message_id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;retry_count&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="s2">&quot;from_prev_conn&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="s2">&quot;result&quot;</span><span class="p">:</span>  <span class="p">{</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                                   <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">body</span><span class="p">,</span>
                                   <span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">destination</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="p">[</span><span class="n">message_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">failure</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed </span><span class="si">%d</span><span class="s2"> times to deliver Resilient ack for message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">failure</span><span class="p">[</span><span class="s2">&quot;retry_count&quot;</span><span class="p">],</span> <span class="n">message_id</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;retry_failed_deliveries&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_retry_send_failures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;retry all messages in the delivery_failures dict that are from the current session&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
            <span class="c1"># Retries not applicable, probably using a mocked appliance</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping retry of any failed messages because STOMP connection is down&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">to_retry</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;from_prev_conn&quot;</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">msgid</span><span class="p">,</span> <span class="n">failure_info</span> <span class="ow">in</span> <span class="n">to_retry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">[</span><span class="n">msgid</span><span class="p">][</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_stomp_ack_delivery_failures</span><span class="p">[</span><span class="n">msgid</span><span class="p">][</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrying failed STOMP ACK for message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msgid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Ack</span><span class="p">(</span><span class="n">failure_info</span><span class="p">[</span><span class="s2">&quot;message_frame&quot;</span><span class="p">]))</span>

        <span class="n">to_retry</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;from_prev_conn&quot;</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">msgid</span><span class="p">,</span> <span class="n">failure_info</span> <span class="ow">in</span> <span class="n">to_retry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Retrying failed Resilient ACK for message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msgid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="p">[</span><span class="n">msgid</span><span class="p">][</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_resilient_ack_delivery_failures</span><span class="p">[</span><span class="n">msgid</span><span class="p">][</span><span class="s2">&quot;retry_count&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Send</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">failure_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;headers&quot;</span><span class="p">],</span>
                           <span class="n">body</span><span class="o">=</span><span class="n">failure_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">],</span>
                           <span class="n">destination</span><span class="o">=</span><span class="n">failure_info</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">],</span>
                           <span class="n">message_id</span><span class="o">=</span><span class="n">msgid</span><span class="p">))</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;signal&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_on_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signo</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;We implement a default-event handler, which means we don&#39;t get default signal handling - add it back</span>
<span class="sd">           (see FallBackSignalHandler in circuits/core/helpers.py)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signo</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">SIGTERM</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;reload&quot;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">opts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;New config, reconnect to stomp if required&quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Actions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_opts</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stomp_component</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Disconnect</span><span class="p">(</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s2">&quot;Disconnect_success&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_stomp</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s2">&quot;Connect_success&quot;</span><span class="p">)</span>
            <span class="n">subscribe_event</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;subscribe_to_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">subscribe_event</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">subscribe_event</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@handler</span><span class="p">(</span><span class="s2">&quot;StatusMessageEvent&quot;</span><span class="p">,</span> <span class="s2">&quot;FunctionErrorEvent&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Report an interim status&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ActionMessageBase</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">fevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span>
        <span class="c1"># Reply with interim status</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">text</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;(No status)&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">FunctionErrorEvent</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">complete</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fevent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># Stop further event processing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">complete</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">fevent</span><span class="o">.</span><span class="n">hdr</span><span class="p">()</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message-id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">reply_to</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;reply-to&#39;</span><span class="p">]</span>
        <span class="n">correlation_id</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">]</span>
        <span class="n">reply_message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                                    <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="n">complete</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Send</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">},</span>
                           <span class="n">body</span><span class="o">=</span><span class="n">reply_message</span><span class="p">,</span>
                           <span class="n">destination</span><span class="o">=</span><span class="n">reply_to</span><span class="p">,</span>
                           <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Test action, nothing to Ack</span>
            <span class="c1"># Send a message back to the test client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;test_response&quot;</span><span class="p">,</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test_msg_id</span><span class="p">,</span> <span class="n">reply_message</span><span class="p">),</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Test Action: No ack done.&quot;</span><span class="p">)</span>

    <span class="nd">@handler</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_on_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Report the successful handling of an action event&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ActionMessageBase</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_success&quot;</span><span class="p">):</span>
            <span class="n">fevent</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">if</span> <span class="n">fevent</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not acking deferred message </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fevent</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;success! </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fevent</span><span class="p">)</span>
                <span class="n">fevent</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>  <span class="c1"># Stop further event processing</span>

                <span class="c1"># At completion, the value might be:</span>
                <span class="c1"># - None (if there was no handler or a handler just returned None)</span>
                <span class="c1"># - or a single thing, or a list; where each thing could be</span>
                <span class="c1">#   - a StatusMessage</span>
                <span class="c1">#   - a FunctionResult</span>
                <span class="c1">#   - a plain Python object: string, number, dictionary, etc</span>
                <span class="c1"># Custom Actions don&#39;t have any &quot;result&quot;, so all the values are</span>
                <span class="c1"># concatenated into a status message.</span>
                <span class="c1"># Functions have a result as well as a status message.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
                <span class="n">function_result</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">status_messages</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ActionMessage</span><span class="p">):</span>
                    <span class="c1"># All the values become the status message.</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">StatusMessage</span><span class="p">):</span>
                            <span class="n">status_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionResult</span><span class="p">):</span>
                            <span class="n">status_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StatusMessage</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="c1"># If the function didn&#39;t return a status message, let&#39;s make one.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">status_messages</span><span class="p">:</span>
                        <span class="n">status_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StatusMessage</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;No handler returned a result for this action&quot;</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">FunctionMessage</span><span class="p">):</span>
                    <span class="c1"># The first (and only the first!) FunctionResult is the result.</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionResult</span><span class="p">):</span>
                            <span class="n">function_result</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="k">break</span>
                    <span class="c1"># If there was no FunctionResult, but there was a plain value, convert that to a FunctionResult</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">function_result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionResult</span><span class="p">)</span> <span class="ow">and</span> \
                                <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">StatusMessage</span><span class="p">):</span>
                            <span class="n">function_result</span> <span class="o">=</span> <span class="n">FunctionResult</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="c1"># All the other values become the status message.</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">FunctionResult</span><span class="p">):</span>
                            <span class="k">pass</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">StatusMessage</span><span class="p">):</span>
                            <span class="n">status_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                            <span class="n">status_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StatusMessage</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="c1"># If the function didn&#39;t return a status message, let&#39;s make one.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">status_messages</span><span class="p">:</span>
                        <span class="n">status_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">StatusMessage</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Completed&quot;</span><span class="p">))</span>

                <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">status_messages</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">fevent</span><span class="o">.</span><span class="n">hdr</span><span class="p">()</span>
                <span class="c1"># Ack the message</span>
                <span class="n">message_id</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message-id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ack </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Ack</span><span class="p">(</span><span class="n">fevent</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">))</span>
                <span class="c1"># Reply with success status</span>
                <span class="n">reply_to</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;reply-to&#39;</span><span class="p">]</span>
                <span class="n">correlation_id</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">]</span>
                <span class="c1"># reply_message is an ActionAcknowledgementDTO</span>
                <span class="n">reply_dto</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;message_type&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                             <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
                             <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">function_result</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Result: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">function_result</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">reply_dto</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_result</span><span class="o">.</span><span class="n">value</span>
                <span class="n">reply_message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">reply_dto</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Send</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;correlation-id&#39;</span><span class="p">:</span> <span class="n">correlation_id</span><span class="p">},</span>
                                   <span class="n">body</span><span class="o">=</span><span class="n">reply_message</span><span class="p">,</span>
                                   <span class="n">destination</span><span class="o">=</span><span class="n">reply_to</span><span class="p">,</span>
                                   <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Test action, nothing to Ack</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">FunctionMessage</span><span class="p">):</span>
                        <span class="c1"># Send the value back to the test</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_result&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">result</span><span class="o">=</span><span class="n">function_result</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">parent</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
                    <span class="c1"># Send a message back to the test client</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">Event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;test_response&quot;</span><span class="p">,</span> <span class="n">fevent</span><span class="o">.</span><span class="n">test_msg_id</span><span class="p">,</span> <span class="n">reply_message</span><span class="p">),</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Test Action: No ack done.&quot;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Resilient Python API</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../resilient.html">resilient package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resilient_circuits.html">resilient_circuits package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resilient_lib.html">resilient_lib package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pytest_resilient_circuits.html">pytest_resilient_circuits package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rc-webserver.html">rc-webserver package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rc-cts.html">rc-cts package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2010-2019 International Business Machines Corporation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>